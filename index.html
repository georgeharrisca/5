<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MXL File Download, Analysis, and Part Extraction Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    select, button {
      margin: 20px;
      padding: 10px;
    }
    #partInfo {
      margin-top: 20px;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>Select an MXL File to Download, Analyze, and Extract Parts</h1>

  <!-- Dropdown to select MXL file -->
  <select id="mxlSelect">
    <option value="">-- Select an MXL File --</option>
    <!-- Options will be populated dynamically -->
  </select>
  <button onclick="downloadFile()">Download</button>
  <button onclick="analyzeFile()">Analyze</button>

  <!-- Section to display part information -->
  <div id="partInfo"></div>
  <pre id="output">Waiting for file...</pre>

  <!-- Dropdown for part downloads -->
  <h2>Select a Part to Download</h2>
  <select id="partSelect">
    <option value="">-- Select a Part --</option>
  </select>

  <script src="https://unpkg.com/fflate@0.7.4/umd/index.js"></script>
  <script>
    // List of MXL files (replace with your actual GitHub URLs)
    const files = [
      { name: 'tbm.mxl', url: 'https://raw.githubusercontent.com/georgeharrisca/5/ab3dc973cdbd92eff65d312934e2cca53122bd91/tbm.mxl' },
      // Add more files as needed
    ];

    // Populate the select dropdown
    const selectElement = document.getElementById('mxlSelect');
    files.forEach(file => {
      const option = document.createElement('option');
      option.value = file.url;
      option.textContent = file.name;
      selectElement.appendChild(option);
    });

    // Function to trigger download
    function downloadFile() {
      const selectedFile = selectElement.value;
      if (selectedFile) {
        window.location.href = selectedFile; // Redirect to the file URL for download
      } else {
        alert('Please select a file to download');
      }
    }

    // Function to analyze the selected MXL file
    async function analyzeFile() {
      const selectedUrl = selectElement.value;
      if (!selectedUrl) {
        alert('Please select a file to analyze');
        return;
      }

      const output = document.getElementById("output");
      output.innerText = "Analyzing file...";

      try {
        console.log("Fetching MXL file from:", selectedUrl);
        const response = await fetch(selectedUrl);
        const buffer = await response.arrayBuffer();
        const zip = fflate.unzipSync(new Uint8Array(buffer));

        // Log the zip contents to check what's inside
        console.log("Zip contents:", Object.keys(zip));

        const containerPath = Object.keys(zip).find(p =>
          p.toLowerCase().includes('meta-inf') && p.toLowerCase().endsWith('container.xml')
        );
        if (!containerPath) {
          output.innerText = "Error: container.xml not found.";
          return;
        }

        const containerXML = new TextDecoder().decode(zip[containerPath]);
        console.log("Container XML:", containerXML); // Log container XML

        const parser = new DOMParser();
        const containerDoc = parser.parseFromString(containerXML, "application/xml");

        const rootfile = containerDoc.querySelector("rootfile");
        const musicXMLPath = rootfile?.getAttribute("full-path");
        if (!musicXMLPath || !zip[musicXMLPath]) {
          output.innerText = "Error: .musicxml file not found.";
          return;
        }

        const musicXML = new TextDecoder().decode(zip[musicXMLPath]);
        console.log("MusicXML file:", musicXML); // Log the MusicXML file

        // Extract part data (name and ID) using regex
        const partInfo = extractParts(musicXML);
        if (partInfo.length === 0) {
          console.log("No parts found.");
        }
        displayPartInfo(partInfo);
        populatePartSelect(partInfo);
      } catch (err) {
        output.innerText = "An error occurred:\n" + err.message;
        console.error(err);
      }
    }

    // Function to extract part information (names and IDs) using a regex
    function extractParts(musicXML) {
      const partInfo = [];
      const partRegex = /<part id="([^"]+)">([\s\S]*?)<\/part>/g;
      let match;

      while ((match = partRegex.exec(musicXML)) !== null) {
        const partId = match[1];
        const partXML = match[0]; // Full part XML (from <part> to </part>)

        // Log the full part XML to inspect the structure
        console.log("Full Part XML:", partXML);  // <-- Log the full part XML

        // Updated regex for extracting part name correctly
        const partNameMatch = /<part-name>(.*?)<\/part-name>/.exec(partXML);
        const partName = partNameMatch ? partNameMatch[1] : "(no name)";
        
        // Log the extracted part name to inspect
        console.log("Extracted Part Name:", partName);  // <-- Log the extracted part name

        partInfo.push({ id: partId, name: partName, xml: partXML });
      }

      return partInfo;
    }

    // Function to create MXL zip (directly from part XML string)
    function createMXLZip(partXMLString) {
      const xmlBlob = new Blob([partXMLString], { type: "application/xml" });

      // Create the zip directly
      const zipData = fflate.zipSync([["part.xml", xmlBlob]]);
      return zipData;
    }

    // Display part information
    function displayPartInfo(partInfo) {
      const partInfoContainer = document.getElementById('partInfo');
      partInfoContainer.innerHTML = '';
      partInfo.forEach(info => {
        const paragraph = document.createElement('p');
        paragraph.textContent = `${info.id}: ${info.name}`;
        partInfoContainer.appendChild(paragraph);
      });
    }

    // Populate the dropdown with extracted parts
    function populatePartSelect(partFiles) {
      const partSelect = document.getElementById("partSelect");
      partSelect.innerHTML = '<option value="">-- Select a Part --</option>'; // Clear previous options
      partFiles.forEach(part => {
        const option = document.createElement('option');
        const partURL = URL.createObjectURL(new Blob([part.zip], { type: "application/zip" }));
        option.value = partURL;
        option.textContent = part.name;
        partSelect.appendChild(option);
      });
    }
  </script>
</body>
</html>
